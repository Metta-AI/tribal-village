# Tribal Village Environment

A high-performance multi-agent reinforcement learning environment built in Nim with PufferLib integration. This project provides both a standalone visual game and a Python-compatible RL environment for training AI agents.

## üéØ Quick Start

### Standalone Visual Game
```bash
nim r tribal_village.nim
```

### PufferLib Environment
```bash
./build_lib.sh  # Build shared library
python -c "from tribal_village_env import TribalVillageEnv; env = TribalVillageEnv(); print('‚úì Environment ready')"
```

## üèóÔ∏è Architecture Overview

### Core Components

**Main Game Engine** (`tribal_village.nim`)
- Real-time visual simulation with interactive controls
- Built-in AI agents with specialized roles (AltarSpecialist, ForgeSpecialist, etc.)
- Clean UI with inventory overlay and agent control

**Environment System** (`src/environment.nim`)
- Large 192x108 map with procedural terrain generation
- 15 agents organized into 3 villages (5 agents per village)
- Rich resource system: ore, batteries, water, wheat, wood, spear, lantern, armor, bread
- Complex crafting chains: ore ‚Üí battery ‚Üí hearts, wood ‚Üí spear/armor, wheat ‚Üí bread/lantern

**Controller System** (`src/external_actions.nim`)
- Dual-mode operation: BuiltinAI or ExternalNN (for Python training)
- Player controls via `playerControlledStep()` function
- AI actions generated by specialized agent roles

**PufferLib Integration** (`src/tribal_village_interface.nim`)
- Zero-copy C interface using direct pointer access
- Efficient observation encoding (21 layers, 11x11 grid per agent)
- Compatible with PufferLib training pipelines

## üéÆ Interactive Controls

### Agent Selection & Info Display
- **Click on agents** to select them and view detailed inventory in top-left overlay
- **Inventory display shows**: Agent ID, orientation, all resource counts (ore, batteries, water, wheat, wood, spear, lantern, armor, bread)
- **Building info**: Shows status when clicking on altars, converters, mines, etc.

### Agent Movement Controls
When an agent is selected, use:
- **Arrow Keys / WASD**: Cardinal movement (North, South, East, West)
- **Q, E, Z, C**: Diagonal movement (Northwest, Northeast, Southwest, Southeast)
- **U**: Use/interact with adjacent building or resource
- **P**: Special action

### Global Controls
- **Space**: Pause/step simulation
- **-/+**: Decrease/increase simulation speed
- **N/M**: Change observation layer display
- **Mouse**: Pan and zoom the map view

## üìÅ Source File Structure

### Core Game Engine (7 files)
- **`environment.nim`** (1200+ lines) - Complete game simulation, terrain generation, agent logic
- **`renderer.nim`** (440+ lines) - All rendering including floors, terrain, objects, UI overlays
- **`controls.nim`** (60 lines) - Player input handling and agent control
- **`ai.nim`** (670+ lines) - Sophisticated AI with role-based specialization and spiral search
- **`common.nim`** (140+ lines) - Core types, panels, settings, utilities
- **`objects.nim`** (130+ lines) - Game objects, buildings, terrain definitions
- **`terrain.nim`** (570+ lines) - Procedural terrain generation with rivers, wheat fields, tree groves

### UI & Rendering (3 files)
- **`ui.nim`** (140 lines) - UI components, buttons, resource bars, tooltips
- **`panels.nim`** (90 lines) - Panel system for layout management
- **`utils.nim`** (90 lines) - Text rendering, performance monitoring

### Integration Layer (2 files)
- **`external_actions.nim`** (120 lines) - Controller abstraction for AI/Python integration
- **`tribal_village_interface.nim`** (180 lines) - C interface for PufferLib with zero-copy arrays

### Python Integration (2 files)
- **`tribal_village_env/environment.py`** (180+ lines) - PufferLib-compatible environment wrapper
- **`tribal_village_env/__init__.py`** - Python package initialization

### Build & Configuration (3 files)
- **`tribal_village.nim`** (160 lines) - Main executable with asset loading and initialization
- **`build_lib.sh`** - Cross-platform shared library build script
- **`tribal_village.nimble`** - Nim package configuration with dependencies

## üéØ Game Mechanics

### Agent Roles & Specialization
Each agent has a specialized role that determines their AI behavior:

1. **AltarSpecialist** - Handles the ore ‚Üí battery ‚Üí hearts workflow for team survival
2. **ForgeSpecialist** - Crafts spears from wood and hunts Clippies for team defense
3. **ArmorySpecialist** - Creates armor from wood and distributes to teammates
4. **ClayOvenSpecialist** - Bakes bread from wheat and feeds hungry teammates
5. **WeavingLoomSpecialist** - Weaves lanterns from wheat and plants them for territory control

### Resource & Crafting System
**Primary Resources**: ore, water, wheat, wood
**Crafted Items**: batteries, spears, armor, bread, lanterns
**Key Chains**:
- `Ore (mines) ‚Üí Batteries (converters) ‚Üí Hearts (altars)` - Core survival loop
- `Wood (trees) ‚Üí Spears (forge) ‚Üí Clippy hunting` - Combat system
- `Wood (trees) ‚Üí Armor (armory) ‚Üí Agent protection` - Defense system
- `Wheat (fields) ‚Üí Bread (clay oven) ‚Üí Agent sustenance` - Food system
- `Wheat (fields) ‚Üí Lanterns (weaving loom) ‚Üí Territory control` - Expansion system

### Combat & Threats
- **Clippies**: Hostile entities that spawn periodically and attack agents/altars
- **Spear Combat**: Agents with spears can attack Clippies from range 1-2
- **Territory Control**: Planted lanterns spread team colors and provide strategic advantages

### Map Generation
- **Procedural 192x108 maps** with rivers, wheat fields, and tree groves
- **Village Placement**: 3 villages in corners with specialized buildings
- **Dynamic Terrain**: Rivers fork and create natural boundaries
- **Resource Distribution**: Strategic placement of mines, converters, and crafting stations

## üîß Technical Details

### Performance Features
- **Zero-copy PufferLib integration** using direct memory pointers
- **Efficient observation encoding** with sparse token representation
- **Optimized rendering** with dirty region updates and batched drawing
- **Multi-threaded safe** design for Python integration

### Observation Space
- **21 observation layers** including agent positions, inventories, building states
- **11x11 local grid** per agent with ego-centric view
- **Token-based encoding** for efficient RL training (max 2541 tokens per agent)

### Action Space
- **Movement**: 8-directional (cardinal + diagonal)
- **Interactions**: Use/craft, attack, give items, plant lanterns
- **Multi-discrete encoding**: `[move_direction, action_type]`

## üêç Python Integration

The PufferLib integration provides a seamless interface for RL training:

```python
from tribal_village_env import TribalVillageEnv

# Create environment
env = TribalVillageEnv(config={'max_steps': 512})

# Standard gymnasium interface
obs, info = env.reset()
action = env.single_action_space.sample()
obs, reward, terminated, truncated, info = env.step({"agent_0": action})
```

### Key Features
- **Single-agent PufferLib interface** (controls one agent, others use AI)
- **Efficient pointer-based communication** with the Nim backend
- **Configurable agent selection** via `agent_id` parameter
- **Standard gymnasium spaces** for easy integration with RL libraries

## üõ†Ô∏è Development

### Dependencies
- **Nim 2.2.4+** with packages: boxy, windy, vmath, chroma, pixie
- **Python 3.8+** with packages: gymnasium, numpy, pufferlib (for RL integration)
- **OpenGL** support for rendering

### Building
```bash
# Compile main executable
nim c tribal_village.nim

# Build PufferLib shared library
./build_lib.sh

# Development build with debug symbols
nim c --opt:none --debugger:native tribal_village.nim
```

### Environment Variables
- `TRIBAL_PYTHON_CONTROL=1` - Disable built-in AI for external control
- `TRIBAL_EXTERNAL_CONTROL=1` - Same as above
- `--external-controller` - Command line flag for external control

## üé® Visual Features

### Real-time Rendering
- **Tile-based 2D graphics** with procedural terrain
- **Agent animations** with orientation and team coloring
- **Dynamic lighting effects** from lanterns and environmental tinting
- **Fog of war** and visual range indicators

### Interactive UI
- **Clean inventory overlay** (adapted from MettaScope2 patterns)
- **Pan and zoom** with mouse controls
- **Speed controls** with play/pause functionality
- **Visual debugging** with observation layer display (N/M keys)

## üìä Performance

- **~2.5s compilation time** with full optimization
- **Multi-agent simulation** handling 15 agents + 100+ game objects
- **Real-time rendering** at 60+ FPS on modern hardware
- **Memory efficient** with pre-allocated arrays and minimal allocations

---

*Built with ‚ù§Ô∏è using Nim's performance and Python's ecosystem*